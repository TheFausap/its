;;;-*-Midas-*-

;;; Chat communications area format.

.begin com

define defloc name,size=1
name=:.loc.
.loc.==.loc.+<size>
termin

define def name,size=1
name==:.val.
.val.==.val.+<size>
termin

dpage==:10	;Starting on page 10 in the demon.
maxj==:150.	;MC currently has 120. jobs.

;;;Pre-allocated bits in DHANG
%k==:525252,,525252
%krlt==:1_0	;Realtime interrupt.
%kdie==:1_1	;Request to terminate.
nmsgs==:34.	;The rest are msg bits.

;;;Buffer format.  All sizes are in bytes.  Entries marked with a star are
;;;initialized by the demon from information supplied in the initial messages.
.val.==0
def iuser	;* UIND of input side.
def ouser	;* UIND of output side.
def bsize	;* Total space in buffer.
def icount	;* Count of free space minus one.  If the input side
		;deposits a byte and decrements this count to be -1, then
		;it must consider the connection to be broken.  If the
		;output side increments this count and it becomes 0, then
		;it knows that the connection has been broken.
def ocount	;* Count of occupied space.  Incremented by the output side
		;AFTER depositing a byte but BEFORE delivering the wakeup.
		;If the input side decrements this to 0, then it knows it
		;will recieve a wakeup when the next byte in input.
def wkmask	;* A mask of bits to use to wake up the output side.
def wkaddr	;A pointer to the output side's UHANG word.  For use by the
		;input side.
def inext	;The input side uses this to build a linked list of
		;buffers.
def iwrap	;Count of empty space before wraparound for input side. 
def owrap	;Count of empty space before wraparound for output side. 
def iptr	;Byte pointer for input side.
def optr	;Byte pointer for output side.
def buffer	;First location of buffer.

ifdef page,[

.loc.==page_12

defloc count		;Count of jobs using the area.
defloc tick		;Demon increments this every minute.
defloc uhang,maxj	;Users hang on bits in these words.
dhang==:uhang+0		;Demon hangs on bits in this word.
			; (SYS job can't be a user!)
defloc lock,nmsgs	;Locks for msg bits in DHANG.
defloc user,nmsgs	;UIND of owners of locks.
defloc msg,nmsgs	;Messages.


npages==:<<.loc.+1777>_-12>-page

] ;end ifndef page,

.end com
